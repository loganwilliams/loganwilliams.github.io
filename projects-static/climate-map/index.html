<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Greenhouse Gas Emissions, Land Use and Wealth</title>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto+Mono:300i,400,700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Roboto Mono";
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      #menu {
        z-index: 10;
        position: absolute;
        left: 2em;
        top: 1em;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 400px;
      }

      button {
        font-family: "Roboto Mono";
        padding: 5px;
        border: none;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        margin-bottom: 0.5em;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(64, 64, 64, 0.25);
        text-align: left;
        margin-right: 0.6em;
      }

      button:hover {
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(0.25, 0.25, 0.25, 1);
        background-color: white;
      }

      div.break {
        height: 1px;
        width: 400px;
        background-color: rgba(255, 255, 255, 0.5);
        margin-bottom: 0.25em;
        margin-top: 0.05em;
      }

      button.active {
        background-color: #fde725;
      }

      .bar {
        height: 20px;
        width: 100%;
        background: linear-gradient(
          to right,
          #440154,
          #3b528b,
          #21918c,
          #5ec962,
          #fde725
        );

        border-radius: 2px;
      }

      #legend {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        padding: 5px;
        margin-bottom: 0.25em;
        width: 100%;
      }

      .labels {
        display: flex;
        justify-content: space-between;
        width: 100%;
        font-family: "Roboto Mono";
        color: black;
        font-size: 12px;
      }

      #info {
        margin-bottom: 0.75em;
        font-size: 12px;
        color: white;
        text-shadow: 0px 0px 1px black;
      }

      #info a {
        color: white;
      }

      #me {
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div id="menu">
      <div id="info">
        <p>
          An attempt to dig deeper into the interrelation of land use, wealth,
          and greenhouse gas emissions.
        </p>
        <p>
          I found the difference between emissions per household and emissions
          per person to reveal some fascinating patterns about unsustainable
          consumption in dense, wealthy urban centers.
        </p>

        <p>
          Data from the
          <a href="https://coolclimate.berkeley.edu/">CoolClimate Network</a> at
          UC Berkeley.
        </p>

        <div id="me"><a href="http://subject.space">- Logan Williams</a></div>
      </div>
      <div id="legend">
        <div class="bar"></div>
        <div class="labels">
          <div id="min">0</div>
          <div id="qr">8</div>
          <div id="mid">15</div>
          <div id="tqr">23</div>
          <div id="max">30</div>
        </div>
      </div>
      <div class="break"></div>
    </div>
    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibG9nYW53IiwiYSI6IlQzWHJqc3cifQ.KY3j-syHXeYmI69JmLqGqQ";
      var map = new mapboxgl.Map({
        container: "map", // container id
        style: "mapbox://styles/loganw/cjw2lh3gm060e1cmru7w3lfk0",
        center: [-74, 40.7], // starting position [lng, lat]
        zoom: 9, // starting zoom
        maxZoom: 14,
        minZoom: 3
      });

      let min = 0;
      let range = 30 - min;

      map.on("load", function() {
        map.addLayer(
          {
            id: "zipcodes",
            type: "fill",
            source: {
              type: "vector",
              url: "mapbox://loganw.6l0uhilq"
            },
            "source-layer": "joined2",
            paint: {
              "fill-color": [
                "interpolate",
                ["linear"],
                [
                  "/",
                  ["get", "Total Household Carbon Footprint (tCO2e/yr)"],
                  ["get", "PersonsPerHousehold"]
                ],
                0 * range + min,
                "#440154",
                0.25 * range + min,
                "#3b528b",
                0.5 * range + min,
                "#21918c",
                0.75 * range + min,
                "#5ec962",
                1.0 * range + min,
                "#fde725"
              ],
              "fill-opacity": [
                "case",
                ["has", "Total Household Carbon Footprint (tCO2e/yr)"],
                0.8,
                0.0
              ],
              "fill-outline-color": "rgba(1,1,1,0)"
            }
          },
          "hillshade_highlight_bright"
        );

        let variables = [
          {
            id: [
              "/",
              ["get", "Total Household Carbon Footprint (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 0,
            max: 30,
            name:
              "Per capita carbon footprint (tCO2e/yr normalized by household size)",
            default: true
          },
          {
            id: [
              "/",
              ["get", "Total Zip Code Carbon Footprint (tCO2e/yr)"],
              ["get", "Population"]
            ],
            min: 0,
            max: 30,
            name: "Per capita carbon footprint (tCO2e/yr normalized by ZIP)"
          },
          {
            id: "Total Household Carbon Footprint (tCO2e/yr)",
            min: 0,
            max: 75,
            name: "Per household carbon footprint (tCO2e/yr)"
          },
          {
            id: "break"
          },
          {
            id: "Housing (tCO2e/yr)",
            min: 3.84,
            max: 25,
            name: "Housing carbon footprint, per household (tCO2e/yr)"
          },
          {
            id: "Transport (tCO2e/yr)",
            min: 2.76,
            max: 30,
            name: "Transport carbon footprint, per household (tCO2e/yr)"
          },
          {
            id: "Food (tCO2e/yr)",
            min: 3,
            max: 12,
            name: "Food carbon footprint, per household (tCO2e/yr)"
          },
          {
            id: "Goods (tCO2e/yr)",
            min: 2.5,
            max: 10,
            name: "Goods carbon footprint, per household (tCO2e/yr)"
          },
          {
            id: "Services (tCO2e/yr)",
            min: 2.5,
            max: 12,
            name: "Services carbon footprint, per household (tCO2e/yr)"
          },
          {
            id: "break"
          },
          {
            id: [
              "/",
              ["get", "Housing (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 3.84 * 0.4,
            max: 25 * 0.4,
            name: "Housing carbon footprint, per capita (tCO2e/yr)"
          },
          {
            id: [
              "/",
              ["get", "Transport (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 2.76 * 0.4,
            max: 30 * 0.4,
            name: "Transport carbon footprint, per capita (tCO2e/yr)"
          },
          {
            id: [
              "/",
              ["get", "Food (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 3 * 0.4,
            max: 12 * 0.4,
            name: "Food carbon footprint, per capita (tCO2e/yr)"
          },
          {
            id: [
              "/",
              ["get", "Goods (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 2.5 * 0.4,
            max: 10 * 0.4,
            name: "Goods carbon footprint, per capita (tCO2e/yr)"
          },
          {
            id: [
              "/",
              ["get", "Services (tCO2e/yr)"],
              ["get", "PersonsPerHousehold"]
            ],
            min: 2.5 * 0.4,
            max: 12 * 0.4,
            name: "Services carbon footprint, per capita (tCO2e/yr)"
          },
          {
            id: "break"
          },
          {
            id: "Nat. Gas (cu.ft.)",
            min: 3505.63,
            max: 103259.13,
            name: "Natural gas (cu.ft./year)"
          },
          {
            id: "FUELOIL (gallons)",
            min: 0,
            max: 700,
            name: "Fuel oil (gallons/year)"
          },
          {
            id: "electricity (kWh)",
            max: 19000,
            min: 2000,
            name: "Electricity (kWh/year)"
          },
          {
            id: "PersonsPerHousehold",
            min: 1,
            max: 4,
            name: "Persons per household"
          },
          {
            id: "Vehicle miles traveled",
            min: 3271,
            max: 40000,
            name: "Vehicle miles traveled (miles/year)"
          },
          {
            id: "IncomePerHousehold",
            min: 2500,
            max: 130000,
            name: "Income per household",
            units: "$"
          },
          {
            id: "AverageHouseValue",
            min: 20000,
            max: 800000,
            name: "Average house value",
            base: 2,
            units: "$"
          },
          {
            id: "popden",
            min: 0,
            max: 30000,
            name: "Population density (pop/sq. mi.)",
            base: 2
          },
          {
            id: "Elevation (ft)",
            min: 0,
            max: 9000,
            base: 2
          }
        ];

        variables.forEach(v => {
          if (v.id === "break") {
            let br = document.createElement("div");
            br.classList.add("break");
            document.getElementById("menu").appendChild(br);
            return;
          }
          let b = document.createElement("button");
          let fillValue = v.id;
          if (!Array.isArray(fillValue)) {
            fillValue = ["get", fillValue];
          }

          let range = v.max - v.min;
          let min = v.min;
          let base = v.base || 1;
          let units = v.units || "";

          let fillStyle = [
            "interpolate",
            ["linear"],
            fillValue,
            Math.pow(0, base) * range + min,
            "#440154",
            Math.pow(0.25, base) * range + min,
            "#3b528b",
            Math.pow(0.5, base) * range + min,
            "#21918c",
            Math.pow(0.75, base) * range + min,
            "#5ec962",
            Math.pow(1.0, base) * range + min,
            "#fde725"
          ];

          console.log(fillStyle);
          b.onclick = () => {
            map.setPaintProperty("zipcodes", "fill-color", fillStyle);
            let buttons = document.getElementsByTagName("button");
            for (let i = 0; i < buttons.length; i++) {
              buttons[i].classList.remove("active");
            }
            document
              .getElementById((v.name ? v.name : v.id).replace(/[\W_]+/g, "_"))
              .classList.add("active");
            document.getElementById("min").innerHTML =
              units + Math.round(Math.pow(0, base) * range + min);
            document.getElementById("qr").innerHTML =
              units + Math.round(Math.pow(0.25, base) * range + min);
            document.getElementById("mid").innerHTML =
              units + Math.round(Math.pow(0.5, base) * range + min);
            document.getElementById("tqr").innerHTML =
              units + Math.round(Math.pow(0.75, base) * range + min);
            document.getElementById("max").innerHTML =
              units + Math.round(Math.pow(1.0, base) * range + min);
          };
          b.innerHTML = v.name ? v.name : v.id;
          b.id = (v.name ? v.name : v.id).replace(/[\W_]+/g, "_");
          if (v.default) b.classList.add("active");

          document.getElementById("menu").appendChild(b);
        });
      });
    </script>
  </body>
</html>
