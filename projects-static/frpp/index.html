<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What the United States Owns</title>
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="What the United States Owns">
    <meta property="og:description" content="Interactive map of Federal Real Property Profile (FRPP) buildings across the United States.">
    <meta property="og:image" content="./image.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="What the United States Owns">
    <meta name="twitter:description" content="Interactive map of Federal Real Property Profile (FRPP) buildings across the United States.">
    <meta name="twitter:image" content="./image.jpg">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
    <!-- Privacy-friendly analytics by Plausible -->
    <script async src="https://plausible.io/js/pa-6YQ8-5DDpmSluNP4euXec.js"></script>
    <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: monospace;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        .maplibregl-popup-content {
            background: rgba(0, 0, 0, 0.9) !important;
            color: white !important;
            padding: 8px 12px !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            font-family: Arial Narrow, sans-serif !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
            max-width: 300px !important;
            text-transform: uppercase;
        }
        .maplibregl-popup-content div.header {
            margin-bottom: 4px;
            font-size: 14px;
            color: white !important;
        }
        .maplibregl-popup-content div {
            margin: 2px 0;
            color: white !important;
        }
        .maplibregl-popup-content hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin: 8px 0;
        }
        .maplibregl-popup-tip {
            border-top-color: rgba(0, 0, 0, 0.9) !important;
        }
        .legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            font-family: Arial Narrow, sans-serif;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            margin-right: 10px;
        }
        .legend h3 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: flex-start;
            margin: 4px 0;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
            align-items: center;
        }
        .legend-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .legend-item.selected {
            background-color: rgba(255, 255, 255, 0.25);
            font-weight: bold;
        }
        .legend-item.dimmed {
            opacity: 0.4;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }
        .legend-label {
            line-height: 1.4;
            /* margin-bottom: -1px; */
        }
        .legend-item.has-children .legend-label::after {
            content: ' ▸';
            opacity: 0.6;
        }
        .legend-item.has-children.expanded .legend-label::after {
            content: ' ▾';
        }
        .legend-bureaus {
            margin-left: 24px;
            display: none;
        }
        .legend-bureaus.expanded {
            display: block;
        }
        .legend-bureau-item {
            font-size: 12px;
        }
        .legend-bureau-item .legend-color {
            width: 12px;
            height: 12px;
        }
        .legal-interest-filters {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .legal-interest-filters select {
            font-size: 14px;
            font-family: Arial Narrow, sans-serif;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            padding: 4px 8px;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
        }
        .year-histogram {
            margin-top: 12px;
            padding-top: 8px;
        }
        .year-histogram-label {
            font-size: 14px;
            margin-bottom: -14px;
            text-transform: uppercase;
        }
        .year-histogram-container {
            position: relative;
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
            cursor: pointer;
        }
        .year-histogram-bar {
            flex: 1;
            min-width: 2px;
            background: rgba(255,255,255,0.25);
            border-radius: 1px 1px 0 0;
            transition: background 0.15s;
        }
        .year-histogram-bar.selected {
            background: rgba(255,255,255,0.6);
        }
        .year-histogram-track {
            position: relative;
            height: 20px;
            margin-top: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
        }
        .year-histogram-selection {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            pointer-events: none;
        }
        .year-histogram-handle {
            position: absolute;
            top: 0;
            width: 10px;
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
            cursor: ew-resize;
            margin-left: -5px;
        }
        .year-histogram-handle:hover {
            background: white;
        }
        .year-histogram-axis {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }
        .year-histogram-footer {
            display: none;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }
        .year-show-all-btn {
            font-size: 11px;
            font-family: Arial Narrow, sans-serif;
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .year-show-all-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.85);
        }
        @media (max-width: 768px) {
            .fullscreen-btn {
                display: none !important;
            }
            .legend {
                display: flex;
                flex-wrap: wrap;
                flex-direction: row;
                gap: 8px;
                max-height: none;
                overflow-y: visible;
                padding: 8px;
                font-size: 12px;
            }
            .legal-interest-filters {
                flex: 1 1 100%;
                min-width: 140px;
            }
            .legal-interest-filters select {
                font-size: 12px;
            }
            .year-histogram-label {
                font-size: 12px;
            }
            .year-histogram-axis,
            .year-histogram-footer {
                font-size: 10px;
            }
            .legend-item {
                display: inline-flex;
                align-items: center;
                margin: 0;
                white-space: nowrap;
            }
            .legend-color {
                width: 12px;
                height: 12px;
                margin-right: 4px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button type="button" class="fullscreen-btn" id="fullscreen-btn" title="Toggle fullscreen" aria-label="Toggle fullscreen">⛶</button>
    <div class="legend" id="legend">
        <div id="legend-agencies"></div>
        <div class="legal-interest-filters">
            <select id="legal-interest-select">
                <option value="both">Owned and Leased</option>
                <option value="owned">Owned</option>
                <option value="leased">Leased</option>
            </select>
            <div class="year-histogram" id="year-histogram">
                <div class="year-histogram-label">Year of construction</div>
                <div class="year-histogram-container" id="year-histogram-bars" title="Click to select range"></div>
                <div class="year-histogram-track" id="year-histogram-track" title="Drag handles to select range">
                    <div class="year-histogram-selection" id="year-histogram-selection"></div>
                    <div class="year-histogram-handle" id="year-handle-min"></div>
                    <div class="year-histogram-handle" id="year-handle-max"></div>
                </div>
                <div class="year-histogram-axis">
                    <span id="year-min-label">1700</span>
                    <span id="year-max-label">2030</span>
                </div>
                <div class="year-histogram-footer" id="year-histogram-footer">
                    <span id="year-undefined-count"></span>
                    <button type="button" id="year-show-all-btn" class="year-show-all-btn">Show all</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        // Agencies to group into "OTHER"
        const otherAgencies = [
            'INDEPENDENT GOVERNMENT OFFICES',
            'DEFENSE/WHS',
            'UNITED STATES HOLOCAUST MEMORIAL MUSEUM',
            'U.S. INTERNATIONAL DEVELOPMENT FINANCE CORPORATION',
            'NATIONAL CREDIT UNION ADMINISTRATION',
            'FEDERAL RETIREMENT THRIFT INVESTMENT BOARD',
            'DC COURT SERVICES & OFFENDER SUPERVISION AGENCY',
            'PEACE CORPS',
            'PRETRIAL SERVICES FOR DC',
            'REGIONAL COMMISSIONS',
            'EXECUTIVE OFFICE OF THE PRESIDENT',
            'MERIT SYSTEMS PROTECTION BOARD',
            'ENVIRONMENTAL PROTECTION AGENCY'
        ];

        // Single dictionary mapping agencies to colors
        // Ordered by square footage (descending), with most distinct colors first
        // ARMY, AIR FORCE, and NAVY are all blue variants
        const agencyColors = {
            // Top 3: Military branches (all blue variants)
            'DEFENSE': '#1565C0',                    // Darker blue
            
            'AGRICULTURE': '#55cf5a',                       // Light green
            'INTERIOR': '#FF9800',                          // Orange (BLM)
            'HOMELAND SECURITY': '#ff0000',                 // Purple

            // Next largest agencies (maximally distinct colors)
            'GENERAL SERVICES ADMINISTRATION': '#ffb3c4',  // Red
            'VETERANS AFFAIRS': '#FF00FF',                 // Fuchsia
            'ENERGY': '#FFEAA7',                            // Yellow

            'COMMERCE': '#26A69A',                       // Teal
            'TRANSPORTATION': '#673AB7',                     // Indigo purple

            'TENNESSEE VALLEY AUTHORITY': '#fcdf03',         // Light yellow
            'STATE': '#9efff4',                              // Light blue

            'NATIONAL AERONAUTICS AND SPACE ADMINISTRATION': '#FF5722',  // Deep orange-red
            'JUSTICE': '#7B1FA2',                           // Dark purple

            'HEALTH AND HUMAN SERVICES': '#00BCD4',         // Cyan
            'LABOR': '#4CAF50',                             // Green
            // 'ENVIRONMENTAL PROTECTION AGENCY': '#E91E63',                             // Pink
            'SMITHSONIAN': '#FFC107',                        // Amber

            'OTHER': '#9E9E9E'                              // Grey for grouped agencies
        };

        // Build match expression for map styling
        function buildColorMatchExpression(agencyColors, otherAgencies) {
            // First check if agency is in "other" list
            const caseExpr = ['case'];
            
            // Add checks for each "other" agency
            for (const agency of otherAgencies) {
                caseExpr.push(['==', ['get', 'agency'], agency], agencyColors['OTHER']);
            }
            
            // Then match against individual agencies
            const matchArgs = ['match', ['get', 'agency']];
            for (const [agency, color] of Object.entries(agencyColors)) {
                if (agency !== 'OTHER') {
                    matchArgs.push(agency, color);
                }
            }
            matchArgs.push('#CCCCCC'); // default color
            
            // Combine: if in other list, return OTHER color, otherwise use match
            caseExpr.push(matchArgs);
            return caseExpr;
        }

        // Abbreviations for legend display
        const agencyAbbreviations = {
            'NATIONAL AERONAUTICS AND SPACE ADMINISTRATION': 'NASA',
            // 'HEALTH AND HUMAN SERVICES': 'HHS',
            // 'TENNESSEE VALLEY AUTHORITY': 'TVA',
            // 'GENERAL SERVICES ADMINISTRATION': 'GSA',
        };

        // Bureau configurations for agencies with drill-down
        const agencyBureauConfig = {
            'INTERIOR': {
                bureaus: [
                    'NATIONAL PARK SERVICE',
                    'FISH AND WILDLIFE SERVICE',
                    'BUREAU OF RECLAMATION',
                    'BUREAU OF LAND MANAGEMENT',
                    'BUREAU OF INDIAN AFFAIRS'
                ],
                colors: {
                    'NATIONAL PARK SERVICE': '#1F77B4',      // Blue
                    'FISH AND WILDLIFE SERVICE': '#FF7F0E',  // Orange
                    'BUREAU OF RECLAMATION': '#2CA02C',      // Green
                    'BUREAU OF LAND MANAGEMENT': '#D62728',  // Red
                    'BUREAU OF INDIAN AFFAIRS': '#9467BD',   // Purple
                    'OTHER': '#8C564B'                       // Brown
                },
                abbreviations: {
                    'NATIONAL PARK SERVICE': 'NPS',
                    'FISH AND WILDLIFE SERVICE': 'FWS',
                    'BUREAU OF RECLAMATION': 'BOR',
                    'BUREAU OF LAND MANAGEMENT': 'BLM',
                    'BUREAU OF INDIAN AFFAIRS': 'BIA'
                }
            },
            'AGRICULTURE': {
                bureaus: [
                    'FOREST SERVICE',
                    'AGRICULTURAL RESEARCH SERVICE',
                    'FARM SERVICE AGENCY',
                    'NATURAL RESOURCES CONSERVATION SERVICE'
                ],
                colors: {
                    'FOREST SERVICE': '#2CA02C',                      // Blue
                    'AGRICULTURAL RESEARCH SERVICE': '#FF7F0E',       // Orange
                    'FARM SERVICE AGENCY': '#1F77B4',                   // Green
                    'NATURAL RESOURCES CONSERVATION SERVICE': '#D62728', // Red
                    'OTHER': '#9467BD'                                // Purple
                },
                abbreviations: {
                    'FOREST SERVICE': 'USFS',
                    'AGRICULTURAL RESEARCH SERVICE': 'ARS',
                    'FARM SERVICE AGENCY': 'FSA',
                    'NATURAL RESOURCES CONSERVATION SERVICE': 'NRCS'
                }
            },
            'HOMELAND SECURITY': {
                bureaus: [
                    'U.S. COAST GUARD',
                    'CUSTOMS AND BORDER PROTECTION',
                    'FED LAW ENFORCEMENT TRAINING CTR (FLETC)'
                ],
                colors: {
                    'U.S. COAST GUARD': '#1F77B4',                      // Blue
                    'CUSTOMS AND BORDER PROTECTION': '#FF7F0E',         // Orange
                    'FED LAW ENFORCEMENT TRAINING CTR (FLETC)': '#2CA02C', // Green
                    'OTHER': '#D62728'                                  // Red
                },
                abbreviations: {
                    'U.S. COAST GUARD': 'USCG',
                    'CUSTOMS AND BORDER PROTECTION': 'CBP',
                    'FED LAW ENFORCEMENT TRAINING CTR (FLETC)': 'FLETC'
                }
            },
            'DEFENSE': {
                bureaus: [
                    'AIR FORCE',
                    'ARMY',
                    'NAVY',
                    'CORPS OF ENGINEERS'
                ],
                colors: {
                    'AIR FORCE': '#D62728',           // Red
                    'ARMY': '#2CA02C',                // Green
                    'NAVY': '#1F77B4',                // Blue
                    'CORPS OF ENGINEERS': '#FF7F0E', // Orange
                    'OTHER': '#9467BD'                // Purple
                },
                abbreviations: {
                    'AIR FORCE': 'USAF',
                    'ARMY': 'USA',
                    'NAVY': 'USN',
                    'CORPS OF ENGINEERS': 'USACE'
                }
            },
            'OTHER': {
                field: 'agency',
                // Ordered by square footage (descending)
                bureaus: [
                    'INDEPENDENT GOVERNMENT OFFICES',
                    'ENVIRONMENTAL PROTECTION AGENCY',
                    'UNITED STATES HOLOCAUST MEMORIAL MUSEUM',
                    'U.S. INTERNATIONAL DEVELOPMENT FINANCE CORPORATION',
                    'NATIONAL CREDIT UNION ADMINISTRATION',
                    'FEDERAL RETIREMENT THRIFT INVESTMENT BOARD',
                    'DC COURT SERVICES & OFFENDER SUPERVISION AGENCY',
                    'PEACE CORPS',
                    'PRETRIAL SERVICES FOR DC',
                    'REGIONAL COMMISSIONS',
                    'EXECUTIVE OFFICE OF THE PRESIDENT',
                    'MERIT SYSTEMS PROTECTION BOARD'
                ],
                colors: {
                    'INDEPENDENT GOVERNMENT OFFICES': '#D62728',
                    'ENVIRONMENTAL PROTECTION AGENCY': '#9467BD',
                    'UNITED STATES HOLOCAUST MEMORIAL MUSEUM': '#8C564B',
                    'U.S. INTERNATIONAL DEVELOPMENT FINANCE CORPORATION': '#E377C2',
                    'NATIONAL CREDIT UNION ADMINISTRATION': '#17BECF',
                    'FEDERAL RETIREMENT THRIFT INVESTMENT BOARD': '#BCBD22',
                    'DC COURT SERVICES & OFFENDER SUPERVISION AGENCY': '#FFBB78',
                    'PEACE CORPS': '#98DF8A',
                    'PRETRIAL SERVICES FOR DC': '#AEC7E8',
                    'REGIONAL COMMISSIONS': '#C5B0D5',
                    'EXECUTIVE OFFICE OF THE PRESIDENT': '#C49C94',
                    'MERIT SYSTEMS PROTECTION BOARD': '#F7B6D2',
                    'OTHER': '#9E9E9E'
                }
            }
        };

        // Build color match expression for an agency's bureaus (or OTHER's sub-agencies)
        function buildBureauColorMatchExpression(agency) {
            const config = agencyBureauConfig[agency];
            const field = config.field || 'bureau';
            const matchArgs = ['match', ['get', field]];
            for (const bureau of config.bureaus) {
                matchArgs.push(bureau, config.colors[bureau]);
            }
            matchArgs.push(config.colors['OTHER'] || '#9E9E9E'); // default
            return matchArgs;
        }

        // Track currently selected agency and expanded agency
        let selectedAgency = null;
        let expandedAgency = null;

        // Generate bureau sub-items HTML for an agency
        function generateBureauItems(agency) {
            const config = agencyBureauConfig[agency];
            return Object.entries(config.colors)
                .map(([bureau, color]) => {
                    return `
                        <div class="legend-item legend-bureau-item" data-agency="${agency}" data-bureau="${bureau}">
                            <div class="legend-color" style="background-color: ${color};"></div>
                            <div class="legend-label">${bureau}</div>
                        </div>
                    `;
                }).join('');
        }

        // Generate agency legend HTML with disclosure for bureaus
        function generateAgencyLegend() {
            const legendContainer = document.getElementById('legend-agencies');
            const items = Object.entries(agencyColors)
                .map(([agency, color]) => {
                    const displayName = agencyAbbreviations[agency] || agency;
                    const hasBureaus = agencyBureauConfig[agency];
                    const isExpanded = expandedAgency === agency;
                    
                    let html = `
                        <div class="legend-item${hasBureaus ? ' has-children' : ''}${isExpanded ? ' expanded' : ''}" data-agency="${agency}">
                            <div class="legend-color" style="background-color: ${color};"></div>
                            <div class="legend-label">${displayName}</div>
                        </div>
                    `;
                    
                    // Add bureau sub-items if this agency has them
                    if (hasBureaus) {
                        html += `<div class="legend-bureaus${isExpanded ? ' expanded' : ''}" data-parent="${agency}">`;
                        html += generateBureauItems(agency);
                        html += `</div>`;
                    }
                    
                    return html;
                }).join('');
            legendContainer.innerHTML = items;
        }

        // Generate initial legend
        generateAgencyLegend();

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'cartodb': {
                        type: 'raster',
                        tiles: [
                            'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                            'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                            'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                            'https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '© CARTO'
                    },
                    'frpp': {
                        type: 'vector',
                        url: 'pmtiles://https://data-lake-house.fra1.cdn.digitaloceanspaces.com/frpp8.pmtiles',
                        attribution: 'FRPP Data'
                    }
                },
                layers: [
                    {
                        id: 'cartodb-layer',
                        type: 'raster',
                        source: 'cartodb'
                    },
                    {
                        id: 'frpp-points',
                        type: 'circle',
                        source: 'frpp',
                        'source-layer': 'frpp_merged8',
                        paint: {
                            'circle-color': buildColorMatchExpression(agencyColors, otherAgencies),
                            'circle-radius': [
                                'interpolate',
                                ['exponential', 2],
                                ['zoom'],
                                0, ['*', 0.125, [
                                    'interpolate',
                                    ['linear'],
                                    ['sqrt', ['coalesce', ['get', 'sqft'], 0]],
                                    0, 3,
                                    1000, 20
                                ]],
                                2, ['*', 0.25, [
                                    'interpolate',
                                    ['linear'],
                                    ['sqrt', ['coalesce', ['get', 'sqft'], 0]],
                                    0, 3,
                                    1000, 20
                                ]],
                                4, [
                                    'interpolate',
                                    ['linear'],
                                    ['sqrt', ['coalesce', ['get', 'sqft'], 0]],
                                    0, 3,
                                    1000, 20
                                ],
                                14, [
                                    'interpolate',
                                    ['linear'],
                                    ['sqrt', ['coalesce', ['get', 'sqft'], 0]],
                                    0, 3,
                                    1000, 20
                                ],
                                 21, ['*', 128, [
                                    'interpolate',
                                    ['linear'],
                                    ['sqrt', ['coalesce', ['get', 'sqft'], 0]],
                                    0, 3,
                                    1000, 20
                                ]],
                            ],
                            'circle-stroke-width': 0.5,
                            'circle-stroke-color': 'rgba(255, 255, 255, 0.5)',
                            'circle-opacity': 0.8
                        }
                    }
                ],
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
            },
            center: [-98.5, 39.8],
            zoom: 4,
            maxZoom: 17
        });

        // Create popup element
        const popup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false,
            className: 'map-popup'
        });

        // Show popup on hover
        function buildFeaturePopupHtml(props) {
            let html = '<div class="header"><strong>' + (props['agency'] || 'Unknown') + '</strong>';
            if (props['name']) {
                html += ': ' + props['bureau'] + '</div>'
                html += '<div class="header"><strong>' + props['name'] + '</strong></div>';
            } else {
                html += '</div>';
                html += '<div>' + props['bureau'] + '</div>';
            }
            const rpType = props['type'] || '';
            const rpUse = props['use'] || '';
            if (rpType || rpUse) {
                html += '<div style="font-style: italic;">' + [rpType, rpUse].filter(Boolean).join(' / ') + '</div>';
            }
            const year = parseInt(props['year'], 10);
            if (year && year > 0 && year !== 9999) {
                html += '<div>(BUILT ' + year + ')</div>';
            }
            return html;
        }

        map.on('mousemove', 'frpp-points', (e) => {
            if (e.features.length > 0) {
                const maxFeatures = 5;
                const features = e.features.slice(0, maxFeatures);
                const parts = features.map(f => buildFeaturePopupHtml(f.properties));
                const remainder = e.features.length - maxFeatures;
                const html = parts.join('<hr>') + (remainder > 0 ? '<hr><div style="font-style: italic; opacity: 0.8;">… and ' + remainder + ' more</div>' : '');
                popup.setLngLat(e.lngLat)
                    .setHTML(html)
                    .addTo(map);
            }
        });

        // Hide popup when mouse leaves point
        map.on('mouseleave', 'frpp-points', () => {
            popup.remove();
        });

        // Change cursor to pointer on hover
        map.on('mouseenter', 'frpp-points', () => {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'frpp-points', () => {
            map.getCanvas().style.cursor = '';
        });

        // Legend click handler for filtering
        function updateLegendStyles() {
            const items = document.querySelectorAll('.legend-item');
            items.forEach(item => {
                const agency = item.dataset.agency;
                const isBureauItem = item.classList.contains('legend-bureau-item');
                item.classList.remove('selected', 'dimmed');
                
                if (selectedAgency) {
                    if (isBureauItem) {
                        // Bureau items are shown when their parent is selected
                        if (agency === selectedAgency) {
                            // Don't dim bureau items of the selected agency
                        } else {
                            item.classList.add('dimmed');
                        }
                    } else {
                        // Agency items
                        if (agency === selectedAgency) {
                            item.classList.add('selected');
                        } else {
                            item.classList.add('dimmed');
                        }
                    }
                }
            });
        }

        // Store original color expression
        const originalColorExpression = buildColorMatchExpression(agencyColors, otherAgencies);

        // Legal interest filter: G, 0, or other = owned; L = leased
        function buildLegalInterestFilter() {
            const mode = document.getElementById('legal-interest-select')?.value || 'both';
            if (mode === 'both') return null;
            if (mode === 'owned') {
                return ['!=', ['coalesce', ['get', 'interest'], ''], 'L'];
            }
            if (mode === 'leased') {
                return ['==', ['get', 'interest'], 'L'];
            }
            return null;
        }

        const YEAR_HIST_MIN = 1700;
        const YEAR_HIST_MAX = 2030;
        const YEAR_NUM_BINS = 60;
        let yearHistogramData = [];
        let yearUndefinedCount = 0;
        let selectedYearMin = YEAR_HIST_MIN;
        let selectedYearMax = YEAR_HIST_MAX;
        let yearBrushDragging = null;
        let yearBrushRAF = null;

        function buildYearFilter() {
            if (selectedYearMin === YEAR_HIST_MIN && selectedYearMax === YEAR_HIST_MAX) return null;
            if (selectedYearMin == YEAR_HIST_MIN) selectedYearMin = 1400;
            const year = ['coalesce', ['to-number', ['get', 'year']], 0];
            const hasYear = ['all', ['!=', year, 0], ['!=', year, 9999]];
            return ['all', hasYear, ['>=', year, selectedYearMin], ['<=', year, selectedYearMax]];
        }

        function getYearFromValue(val) {
            val = Math.max(0, Math.min(1, val));
            return Math.round(YEAR_HIST_MIN + val * (YEAR_HIST_MAX - YEAR_HIST_MIN));
        }

        function getValueFromYear(y) {
            return (y - YEAR_HIST_MIN) / (YEAR_HIST_MAX - YEAR_HIST_MIN);
        }

        function updateYearBrushUI() {
            const track = document.getElementById('year-histogram-track');
            const selection = document.getElementById('year-histogram-selection');
            const handleMin = document.getElementById('year-handle-min');
            const handleMax = document.getElementById('year-handle-max');
            const minVal = getValueFromYear(selectedYearMin);
            const maxVal = getValueFromYear(selectedYearMax);
            const left = (minVal * 100) + '%';
            const width = ((maxVal - minVal) * 100) + '%';
            selection.style.left = left;
            selection.style.width = width;
            handleMin.style.left = left;
            handleMax.style.left = (maxVal * 100) + '%';
            document.getElementById('year-min-label').textContent = selectedYearMin;
            document.getElementById('year-max-label').textContent = selectedYearMax;
            yearHistogramData.forEach((count, i) => {
                const barYear = YEAR_HIST_MIN + (i + 0.5) * (YEAR_HIST_MAX - YEAR_HIST_MIN) / YEAR_NUM_BINS;
                const bar = document.getElementById('year-bar-' + i);
                if (bar) bar.classList.toggle('selected', barYear >= selectedYearMin && barYear <= selectedYearMax);
            });
            const footer = document.getElementById('year-histogram-footer');
            const countEl = document.getElementById('year-undefined-count');
            const yearFilterActive = selectedYearMin !== YEAR_HIST_MIN || selectedYearMax !== YEAR_HIST_MAX;
            if (yearFilterActive && yearUndefinedCount > 0) {
                footer.style.display = 'flex';
                countEl.textContent = yearUndefinedCount.toLocaleString() + ' entries missing build year';
            } else {
                footer.style.display = 'none';
            }
        }

        function filterFeaturesByAgency(features) {
            if (!selectedAgency) return features;
            if (selectedAgency === 'OTHER') {
                const otherSet = new Set(otherAgencies);
                return features.filter(f => otherSet.has(f.properties['agency']));
            }
            return features.filter(f => f.properties['agency'] === selectedAgency);
        }

        function filterFeaturesByLegalInterest(features) {
            const mode = document.getElementById('legal-interest-select')?.value || 'both';
            if (mode === 'both') return features;
            return features.filter(f => {
                const code = f.properties['interest'] || '';
                if (mode === 'owned') return code !== 'L';
                if (mode === 'leased') return code === 'L';
                return true;
            });
        }

        function updateYearHistogramVisibility() {
            const el = document.getElementById('year-histogram');
            const legalMode = document.getElementById('legal-interest-select')?.value || 'both';
            const hide = selectedAgency === 'DEFENSE' || selectedAgency === 'TENNESSEE VALLEY AUTHORITY' || legalMode === 'leased';
            if (el) el.style.display = hide ? 'none' : 'block';
        }

        function rebuildYearHistogram() {
            updateYearHistogramVisibility();
            const legalMode = document.getElementById('legal-interest-select')?.value || 'both';
            if (selectedAgency === 'DEFENSE' || selectedAgency === 'TENNESSEE VALLEY AUTHORITY' || legalMode === 'leased') return;
            yearHistogramData = Array(YEAR_NUM_BINS).fill(0);
            yearUndefinedCount = 0;
            const binWidth = (YEAR_HIST_MAX - YEAR_HIST_MIN) / YEAR_NUM_BINS;
            try {
                let features = map.querySourceFeatures('frpp', { sourceLayer: 'frpp_merged8' });
                features = filterFeaturesByAgency(features);
                features = filterFeaturesByLegalInterest(features);
                features.forEach(f => {
                    const y = parseInt(f.properties['year'], 10);
                    if (isNaN(y) || y === 0 || y === 9999) {
                        yearUndefinedCount++;
                    } else if (y >= YEAR_HIST_MIN && y <= YEAR_HIST_MAX) {
                        const bin = Math.min(YEAR_NUM_BINS - 1, Math.floor((y - YEAR_HIST_MIN) / binWidth));
                        yearHistogramData[bin]++;
                    }
                });
            } catch (e) {}
            renderYearHistogram();
        }

        function renderYearHistogram() {
            const container = document.getElementById('year-histogram-bars');
            const maxCount = Math.max(1, ...yearHistogramData);
            container.innerHTML = yearHistogramData.map((count, i) => {
                const pct = (count / maxCount) * 100;
                return `<div class="year-histogram-bar" id="year-bar-${i}" style="height: ${pct}%"></div>`;
            }).join('') || Array(YEAR_NUM_BINS).fill(0).map((_, i) =>
                `<div class="year-histogram-bar" id="year-bar-${i}" style="height: 5%"></div>`
            ).join('');
            updateYearBrushUI();
        }

        function initYearHistogram() {
            const track = document.getElementById('year-histogram-track');
            rebuildYearHistogram();

            const handleRangeClick = (e) => {
                if (e.target.classList.contains('year-histogram-handle')) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const val = (e.clientX - rect.left) / rect.width;
                const year = getYearFromValue(val);
                const mid = (selectedYearMin + selectedYearMax) / 2;
                if (year < mid) {
                    selectedYearMin = Math.min(year, selectedYearMax - 1);
                } else {
                    selectedYearMax = Math.max(year, selectedYearMin + 1);
                }
                updateYearBrushUI();
                applyFilters();
            };

            const handleDrag = (e) => {
                const rect = track.getBoundingClientRect();
                const val = (e.clientX - rect.left) / rect.width;
                const year = getYearFromValue(val);
                if (yearBrushDragging === 'min') {
                    selectedYearMin = Math.min(year, selectedYearMax - 1);
                    selectedYearMin = Math.max(YEAR_HIST_MIN, selectedYearMin);
                } else if (yearBrushDragging === 'max') {
                    selectedYearMax = Math.max(year, selectedYearMin + 1);
                    selectedYearMax = Math.min(YEAR_HIST_MAX, selectedYearMax);
                }
                if (!yearBrushRAF) {
                    yearBrushRAF = requestAnimationFrame(() => {
                        yearBrushRAF = null;
                        updateYearBrushUI();
                    });
                }
            };

            const handleDragEnd = () => {
                const wasDragging = yearBrushDragging;
                yearBrushDragging = null;
                if (wasDragging) applyFilters();
            };

            const handleMin = document.getElementById('year-handle-min');
            const handleMax = document.getElementById('year-handle-max');
            const barsContainer = document.getElementById('year-histogram-bars');
            track.addEventListener('click', handleRangeClick);
            barsContainer.addEventListener('click', handleRangeClick);
            handleMin.addEventListener('mousedown', (e) => { e.preventDefault(); yearBrushDragging = 'min'; });
            handleMax.addEventListener('mousedown', (e) => { e.preventDefault(); yearBrushDragging = 'max'; });
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('mousemove', (e) => { if (yearBrushDragging) handleDrag(e); });

            document.getElementById('year-show-all-btn').addEventListener('click', () => {
                selectedYearMin = YEAR_HIST_MIN;
                selectedYearMax = YEAR_HIST_MAX;
                updateYearBrushUI();
                applyFilters();
            });
        }

        function getAgencyFilter() {
            if (!selectedAgency) return null;
            if (selectedAgency === 'OTHER') {
                const otherFilter = ['any'];
                for (const a of otherAgencies) {
                    otherFilter.push(['==', ['get', 'agency'], a]);
                }
                return otherFilter;
            }
            return ['==', ['get', 'agency'], selectedAgency];
        }

        function applyFilters() {
            const legalFilter = buildLegalInterestFilter();
            const yearFilter = buildYearFilter();
            const agencyFilter = getAgencyFilter();
            const filters = [legalFilter, yearFilter, agencyFilter].filter(Boolean);
            const filter = filters.length === 0 ? null : filters.length === 1 ? filters[0] : ['all', ...filters];
            map.setFilter('frpp-points', filter);
        }

        function resetView() {
            selectedAgency = null;
            expandedAgency = null;
            applyFilters();
            map.setPaintProperty('frpp-points', 'circle-color', originalColorExpression);
            generateAgencyLegend();
            rebuildYearHistogram();
        }

        function filterByAgency(agency) {
            if (selectedAgency === agency && !agencyBureauConfig[agency]) {
                resetView();
            } else {
                selectedAgency = agency;
                
                if (agencyBureauConfig[agency]) {
                    if (expandedAgency === agency) {
                        selectedAgency = null;
                        expandedAgency = null;
                        map.setPaintProperty('frpp-points', 'circle-color', originalColorExpression);
                    } else {
                        expandedAgency = agency;
                        map.setPaintProperty('frpp-points', 'circle-color', buildBureauColorMatchExpression(agency));
                    }
                    generateAgencyLegend();
                } else {
                    map.setPaintProperty('frpp-points', 'circle-color', originalColorExpression);
                    if (expandedAgency) {
                        expandedAgency = null;
                        generateAgencyLegend();
                    }
                }
                rebuildYearHistogram();
                applyFilters();
                updateLegendStyles();
            }
        }

        // Add click listeners to legend items
        document.getElementById('legend').addEventListener('click', (e) => {
            const legendItem = e.target.closest('.legend-item');
            if (legendItem) {
                const agency = legendItem.dataset.agency;
                if (agency) {
                    filterByAgency(agency);
                }
            }
        });

        // Legal interest handler
        document.getElementById('legal-interest-select').addEventListener('change', () => {
            rebuildYearHistogram();
            applyFilters();
        });

        // Fullscreen toggle
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        });
        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreen-btn');
            btn.textContent = document.fullscreenElement ? '✕' : '⛶';
            btn.title = document.fullscreenElement ? 'Exit fullscreen' : 'Toggle fullscreen';
            map.resize();
        });

        // Year histogram - init when map has loaded tiles
        map.on('load', () => map.once('idle', initYearHistogram));
    </script>
</body>
</html>

